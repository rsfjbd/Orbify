<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'/>
    <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no' name='viewport'/>
    <title>Best IPTV</title>
    <link href='//cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css' rel='stylesheet'/>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <link href='style.css' rel='stylesheet'/>
    <script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
</head>
<body>

<div class='main-content'>
    <div class='player-container'>
        <video id="my-video" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto" width="100%" playsinline poster="https://blogger.googleusercontent.com/img/b/R29vZ2xl/AVvXsEji3C6D6HZt-fLDTf1mYZQYIyeUP_VV8UT9jQS-pbEiJu2KVxUL3xdAqnXaKyO_kIICCWn-IWyuq0XevFLIGAqLmSFpdpZzfJKVOrgkmsB9rdoYmgto2wZRJuqHAkIhj9bS7rcVKen3LMLxwWa1ZD1E605gASpoo-wl628yDS0zyNvB3KxC1BfX4oEL/s1920/skviptv.png"></video>
    </div>
    
    <div class='channel-section'>
        <div class='channel-tabs'>
            <button class='tab-btn active' id='allChannelsTab'>All</button>
            <button class='tab-btn' id='categoriesTab'>Categories</button>
            <button class='tab-btn' id='favoritesTab'>Favorites</button>
        </div>
        <div class='search-container'>
            <input class='search-input' id='searchInput' placeholder='Search Best IPTV...' type='text'/>
        </div>
        <div class='channel-grid' id='channelGrid'></div>
    </div>
</div>

<script>
let videoPlayer, channels = [], categories = new Set(), currentPlayingUrl = "";
let favorites = new Set(JSON.parse(localStorage.getItem('favorites') || '[]'));

document.addEventListener('DOMContentLoaded', () => {
    videoPlayer = videojs('my-video', { fluid: true, autoplay: true, liveui: true });
    let sv = new URLSearchParams(window.location.search).get("sv");
    if(sv) parseM3U(sv);
});

function playChannel(url) {
    currentPlayingUrl = url;
    videoPlayer.src({ src: url, type: url.includes('.m3u8') ? 'application/x-mpegURL' : 'video/mp4' });
    
    videoPlayer.ready(() => {
        videoPlayer.muted(false);
        videoPlayer.play().catch(() => { videoPlayer.muted(true); videoPlayer.play(); });
    });

    renderCurrentView(); // লিস্ট রিফ্রেশ করে একটিভ চ্যানেল দেখাবে
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

async function parseM3U(url) {
    const channelGrid = document.getElementById('channelGrid');
    channelGrid.innerHTML = '<div class="loading"></div>';
    try {
        const response = await fetch('https://corsproxy.io/?' + encodeURIComponent(url));
        const text = await response.text();
        const lines = text.split('\n');
        channels = []; categories.clear();
        let current = {};
        lines.forEach(line => {
            if (line.startsWith('#EXTINF:')) {
                current.category = line.match(/group-title="([^"]+)"/)?.[1] || 'Others';
                current.logo = line.match(/tvg-logo="([^"]+)"/)?.[1] || '';
                current.title = line.split(',')[1] || "Unknown";
                categories.add(current.category);
            } else if (line.startsWith('http')) {
                current.url = line;
                if(current.title) channels.push(current);
                current = {};
            }
        });
        showAllChannels();
    } catch (e) { channelGrid.innerHTML = "Error loading list."; }
}

function createChannelCard(ch) {
    const isActive = (ch.url === currentPlayingUrl) ? 'active-channel' : '';
    const isFav = favorites.has(ch.url) ? 'active' : '';
    // ডিফল্ট লোগো হিসেবে FontAwesome আইকন ব্যবহার করা হয়েছে যদি লোগো না থাকে
    const logoSrc = ch.logo ? ch.logo : 'https://via.placeholder.com/100?text=TV';

    return `
        <div class="channel-card ${isActive}" onclick="playChannel('${ch.url}')">
            <div class="channel-image">
                <img src="${logoSrc}" alt="" onerror="this.src='https://via.placeholder.com/100?text=TV'">
            </div>
            <div class="channel-info">
                <div class="channel-name">${ch.title}</div>
                <div class="channel-category">${ch.category}</div>
                <div class="playing-indicator"><i class="fas fa-play"></i> Playing now...</div>
            </div>
            <button class="favorite-btn ${isFav}" onclick="toggleFavorite(event, '${ch.url}')">
                <i class="fas fa-heart"></i>
            </button>
        </div>`;
}

function renderCurrentView() {
    const activeTab = document.querySelector('.tab-btn.active').id;
    if(activeTab === 'allChannelsTab') showAllChannels();
    else if(activeTab === 'favoritesTab') showFavorites();
}

function showAllChannels() { document.getElementById('channelGrid').innerHTML = channels.map(createChannelCard).join(''); }

function showFavorites() {
    const favs = channels.filter(ch => favorites.has(ch.url));
    document.getElementById('channelGrid').innerHTML = favs.length ? favs.map(createChannelCard).join('') : '<div style="text-align:center;padding:20px;">No favorites</div>';
}

function toggleFavorite(e, url) {
    e.stopPropagation();
    favorites.has(url) ? favorites.delete(url) : favorites.add(url);
    localStorage.setItem('favorites', JSON.stringify([...favorites]));
    renderCurrentView();
}

// ট্যাব এবং সার্চ লজিক আগের মতোই কাজ করবে...
document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        if(btn.id === 'categoriesTab') {
            document.getElementById('channelGrid').innerHTML = [...categories].map(cat => `
                <div class="channel-card" onclick="showCat('${cat}')">
                    <div class="channel-info"><div class="channel-name">${cat}</div></div>
                </div>`).join('');
        } else renderCurrentView();
    });
});

function showCat(cat) {
    document.getElementById('channelGrid').innerHTML = channels.filter(ch => ch.category === cat).map(createChannelCard).join('');
}

document.getElementById('searchInput').addEventListener('input', (e) => {
    const term = e.target.value.toLowerCase();
    document.getElementById('channelGrid').innerHTML = channels.filter(ch => ch.title.toLowerCase().includes(term)).map(createChannelCard).join('');
});
</script>
</body>
</html>
